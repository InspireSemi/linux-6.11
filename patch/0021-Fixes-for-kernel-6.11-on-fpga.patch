From 4ff324fcfd9be587f2d37720ac465a870532e883 Mon Sep 17 00:00:00 2001
From: Marc Karasek <mkarasek@inspiresemi.com>
Date: Mon, 23 Sep 2024 10:28:36 -0500
Subject: [PATCH 21/24] Fixes for kernel 6.11 on fpga

---
 .../boot/dts/inspiresemi/inspire_core.dts     |   5 +-
 arch/riscv/configs/fpga_091824_defconfig      | 169 ++++++++++++++++++
 arch/riscv/kernel/traps_misaligned.c          |  25 +--
 include/linux/jiffies.h                       |   6 +-
 saveconfig.sh                                 |   2 +-
 5 files changed, 190 insertions(+), 17 deletions(-)
 create mode 100644 arch/riscv/configs/fpga_091824_defconfig

diff --git a/arch/riscv/boot/dts/inspiresemi/inspire_core.dts b/arch/riscv/boot/dts/inspiresemi/inspire_core.dts
index 61becea7a430..52cdc307848e 100644
--- a/arch/riscv/boot/dts/inspiresemi/inspire_core.dts
+++ b/arch/riscv/boot/dts/inspiresemi/inspire_core.dts
@@ -12,7 +12,7 @@ pmu {
 	};
 
  	chosen {
-		bootargs = "debug console=uart,mmio,0x70010100 earlycon=uart,mmio,0x70010100 rodata=off";
+		bootargs = "debug console=uart,mmio,0x70010100 earlycon=uart,mmio,0x70010100 rodata=off no5lvl";
 		linux,initrd-start = <0x1100 0x04000000>;
 		linux,initrd-end = <0x1100 0x042A7DC9>;
 		rng-seed = <0x4fe9397d 0xb7883060 0xe56ff3c2 0xb05b4e3 0x62e5479c 0xd932a9c8 0x95a47b5b 0x192ef245>;
@@ -35,8 +35,9 @@ cpu@0 {
 			status = "okay";
 			compatible = "riscv";
 			riscv,isa = "rv64imafdcus";
+			riscv,isa-base = "rv64i";
+			riscv,isa-extensions = "i", "m", "a", "f", "d", "c", "zicsr", "zifencei" ;
 			mmu-type = "riscv,sv48";
-
 			intc0: interrupt-controller {
 				#interrupt-cells = <0x01>;
 				interrupt-controller;
diff --git a/arch/riscv/configs/fpga_091824_defconfig b/arch/riscv/configs/fpga_091824_defconfig
new file mode 100644
index 000000000000..a5d0ed3c2f04
--- /dev/null
+++ b/arch/riscv/configs/fpga_091824_defconfig
@@ -0,0 +1,169 @@
+CONFIG_COMPILE_TEST=y
+# CONFIG_WERROR is not set
+CONFIG_SYSVIPC=y
+CONFIG_POSIX_MQUEUE=y
+CONFIG_NO_HZ_IDLE=y
+CONFIG_HIGH_RES_TIMERS=y
+CONFIG_BPF_SYSCALL=y
+CONFIG_IKCONFIG=y
+CONFIG_IKCONFIG_PROC=y
+CONFIG_CGROUPS=y
+CONFIG_CGROUP_SCHED=y
+CONFIG_CFS_BANDWIDTH=y
+CONFIG_CGROUP_BPF=y
+CONFIG_NAMESPACES=y
+CONFIG_USER_NS=y
+CONFIG_INITRAMFS_SOURCE="/home/mkarasek/src/images/rootfs.rvi /home/mkarasek/src/images/default_cpio_list"
+CONFIG_BOOT_CONFIG=y
+CONFIG_CC_OPTIMIZE_FOR_SIZE=y
+CONFIG_EXPERT=y
+# CONFIG_SYSFS_SYSCALL is not set
+CONFIG_ERRATA_SIFIVE=y
+CONFIG_SMP=y
+CONFIG_NR_CPUS=8
+CONFIG_HZ_100=y
+CONFIG_RISCV_SBI_V01=y
+# CONFIG_COMPAT_32BIT_TIME is not set
+CONFIG_MODULES=y
+CONFIG_MODULE_UNLOAD=y
+# CONFIG_IOSCHED_BFQ is not set
+# CONFIG_SWAP is not set
+CONFIG_NET=y
+CONFIG_PACKET=y
+CONFIG_IP_MULTICAST=y
+CONFIG_IP_ADVANCED_ROUTER=y
+CONFIG_IP_PNP=y
+CONFIG_IP_PNP_DHCP=y
+CONFIG_IP_PNP_BOOTP=y
+CONFIG_IP_PNP_RARP=y
+CONFIG_NETLINK_DIAG=y
+CONFIG_NET_9P=y
+CONFIG_NET_9P_VIRTIO=y
+CONFIG_PCI=y
+CONFIG_PCIEPORTBUS=y
+CONFIG_PCI_HOST_GENERIC=y
+CONFIG_PCIE_XILINX=y
+CONFIG_PCIE_FU740=y
+CONFIG_DEVTMPFS=y
+CONFIG_DEVTMPFS_MOUNT=y
+CONFIG_BLK_DEV_LOOP=y
+CONFIG_BLK_DEV_RAM=y
+CONFIG_VIRTIO_BLK=y
+CONFIG_BLK_DEV_NVME=m
+CONFIG_BLK_DEV_SD=y
+CONFIG_BLK_DEV_SR=y
+CONFIG_SCSI_VIRTIO=y
+CONFIG_ATA=y
+CONFIG_SATA_AHCI=y
+CONFIG_SATA_MOBILE_LPM_POLICY=0
+CONFIG_SATA_AHCI_PLATFORM=y
+CONFIG_NETDEVICES=y
+CONFIG_VIRTIO_NET=y
+CONFIG_MACB=y
+CONFIG_E1000E=y
+CONFIG_R8169=y
+CONFIG_MICROSEMI_PHY=y
+CONFIG_INPUT_MOUSEDEV=y
+CONFIG_SERIAL_8250=y
+CONFIG_SERIAL_8250_CONSOLE=y
+CONFIG_SERIAL_OF_PLATFORM=y
+CONFIG_SERIAL_EARLYCON_RISCV_SBI=y
+CONFIG_SERIAL_SIFIVE=y
+CONFIG_SERIAL_SIFIVE_CONSOLE=y
+CONFIG_VIRTIO_CONSOLE=y
+CONFIG_HW_RANDOM=y
+CONFIG_HW_RANDOM_VIRTIO=y
+CONFIG_HW_RANDOM_MESON=y
+CONFIG_HW_RANDOM_MTK=y
+CONFIG_HW_RANDOM_EXYNOS=y
+CONFIG_HW_RANDOM_NPCM=y
+CONFIG_SPI=y
+CONFIG_SPI_SIFIVE=y
+# CONFIG_PTP_1588_CLOCK is not set
+CONFIG_GPIOLIB=y
+CONFIG_GPIO_SIFIVE=y
+CONFIG_POWER_RESET=y
+CONFIG_POWER_RESET_SYSCON=y
+CONFIG_POWER_RESET_SYSCON_POWEROFF=y
+CONFIG_MFD_SUN6I_PRCM=y
+CONFIG_DRM=m
+CONFIG_DRM_RADEON=m
+CONFIG_DRM_NOUVEAU=m
+CONFIG_DRM_VIRTIO_GPU=m
+CONFIG_FB=y
+CONFIG_USB=y
+CONFIG_USB_XHCI_HCD=y
+CONFIG_USB_XHCI_PLATFORM=y
+CONFIG_USB_EHCI_HCD=y
+CONFIG_USB_EHCI_HCD_PLATFORM=y
+CONFIG_USB_OHCI_HCD=y
+CONFIG_USB_OHCI_HCD_PLATFORM=y
+CONFIG_USB_STORAGE=y
+CONFIG_USB_UAS=y
+CONFIG_MMC=y
+CONFIG_MMC_SDHCI=y
+CONFIG_MMC_SDHCI_PLTFM=y
+CONFIG_MMC_SDHCI_CADENCE=y
+CONFIG_MMC_SPI=y
+CONFIG_RTC_CLASS=y
+CONFIG_RTC_DRV_GOLDFISH=y
+CONFIG_VIRTIO_PCI=y
+CONFIG_VIRTIO_BALLOON=y
+CONFIG_VIRTIO_INPUT=y
+CONFIG_VIRTIO_MMIO=y
+CONFIG_GOLDFISH=y
+CONFIG_CLK_SIFIVE=y
+CONFIG_CLK_SIFIVE_PRCI=y
+CONFIG_RPMSG_CHAR=y
+CONFIG_RPMSG_VIRTIO=y
+CONFIG_EXT4_FS=y
+CONFIG_EXT4_FS_POSIX_ACL=y
+CONFIG_AUTOFS_FS=y
+CONFIG_MSDOS_FS=y
+CONFIG_VFAT_FS=y
+CONFIG_PROC_CHILDREN=y
+CONFIG_TMPFS=y
+CONFIG_TMPFS_POSIX_ACL=y
+CONFIG_NFS_FS=y
+CONFIG_NFS_V2=y
+CONFIG_NFS_V4=y
+CONFIG_NFS_V4_1=y
+CONFIG_NFS_V4_2=y
+CONFIG_ROOT_NFS=y
+# CONFIG_NFS_V4_2_READ_PLUS is not set
+CONFIG_9P_FS=y
+CONFIG_NLS_CODEPAGE_437=y
+CONFIG_NLS_ISO8859_1=m
+CONFIG_LSM="landlock,lockdown,yama,loadpin,safesetid,integrity,bpf"
+CONFIG_INIT_STACK_NONE=y
+CONFIG_BUG_ON_DATA_CORRUPTION=y
+CONFIG_CRYPTO_USER_API_HASH=y
+CONFIG_CRYPTO_DEV_VIRTIO=y
+CONFIG_PRINTK_TIME=y
+CONFIG_PRINTK_CALLER=y
+# CONFIG_DEBUG_MISC is not set
+CONFIG_VMLINUX_MAP=y
+CONFIG_DEBUG_PAGEALLOC=y
+CONFIG_SCHED_STACK_END_CHECK=y
+CONFIG_DEBUG_VM=y
+CONFIG_DEBUG_VM_MAPLE_TREE=y
+CONFIG_DEBUG_VM_RB=y
+CONFIG_DEBUG_VM_PGFLAGS=y
+CONFIG_DEBUG_VIRTUAL=y
+CONFIG_DEBUG_MEMORY_INIT=y
+CONFIG_SOFTLOCKUP_DETECTOR=y
+# CONFIG_DETECT_HUNG_TASK is not set
+CONFIG_WQ_WATCHDOG=y
+CONFIG_DEBUG_RT_MUTEXES=y
+CONFIG_DEBUG_SPINLOCK=y
+CONFIG_DEBUG_MUTEXES=y
+CONFIG_DEBUG_RWSEMS=y
+CONFIG_DEBUG_ATOMIC_SLEEP=y
+CONFIG_DEBUG_LIST=y
+CONFIG_DEBUG_PLIST=y
+CONFIG_DEBUG_SG=y
+CONFIG_RCU_CPU_STALL_TIMEOUT=12
+# CONFIG_RCU_TRACE is not set
+CONFIG_RCU_EQS_DEBUG=y
+# CONFIG_FTRACE is not set
+# CONFIG_RUNTIME_TESTING_MENU is not set
diff --git a/arch/riscv/kernel/traps_misaligned.c b/arch/riscv/kernel/traps_misaligned.c
index d4fd8af7aaf5..b422fabf3562 100644
--- a/arch/riscv/kernel/traps_misaligned.c
+++ b/arch/riscv/kernel/traps_misaligned.c
@@ -555,19 +555,22 @@ static bool check_unaligned_access_emulated(int cpu)
 
 bool check_unaligned_access_emulated_all_cpus(void)
 {
-	int cpu;
+	// int cpu;
 
-	/*
-	 * We can only support PR_UNALIGN controls if all CPUs have misaligned
-	 * accesses emulated since tasks requesting such control can run on any
-	 * CPU.
-	 */
-	for_each_online_cpu(cpu)
-		if (!check_unaligned_access_emulated(cpu))
-			return false;
+	// /*
+	//  * We can only support PR_UNALIGN controls if all CPUs have misaligned
+	//  * accesses emulated since tasks requesting such control can run on any
+	//  * CPU.
+	//  */
+	// for_each_online_cpu(cpu)
+	// 	if (!check_unaligned_access_emulated(cpu))
+	// 	 	return false;
+
+	// unaligned_ctl = true;
+	// return true;
+
+	return false;
 
-	unaligned_ctl = true;
-	return true;
 }
 
 bool unaligned_ctl_available(void)
diff --git a/include/linux/jiffies.h b/include/linux/jiffies.h
index 94d6a1515dc8..e13c5a15749a 100644
--- a/include/linux/jiffies.h
+++ b/include/linux/jiffies.h
@@ -20,9 +20,9 @@
  * OSF/1 kernel. The SHIFT_HZ define expresses the same value as the
  * nearest power of two in order to avoid hardware multiply operations.
  */
-+#if HZ >= 3 && HZ < 6
-+#define SHIFT_HZ 3
-+#elif HZ >= 6 && HZ < 12
+#if HZ >= 3 && HZ < 6
+#define SHIFT_HZ 3
+#elif HZ >= 6 && HZ < 12
 # define SHIFT_HZ 3
 #elif HZ >= 12 && HZ < 24
 # define SHIFT_HZ	4
diff --git a/saveconfig.sh b/saveconfig.sh
index 74584ccd52c7..fb08c8e442bb 100755
--- a/saveconfig.sh
+++ b/saveconfig.sh
@@ -1 +1 @@
-make ARCH=riscv CROSS_COMPILE=riscv64-poky-linux- O=../linux_build savedefconfig
+make ARCH=riscv CROSS_COMPILE=riscv64-unknown-linux-gnu- O=../linux_build savedefconfig
-- 
2.39.3

